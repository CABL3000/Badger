<!--
  To change this template, choose Tools | Templates
  and open the template in the editor.
-->

<%@ page contentType="text/html;charset=UTF-8" %>

<html>
  <head>
    <meta name='layout' content='main'/>
    <parameter name="blast" value="selected"></parameter>
    <meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
    <title>BLAST</title>
  </head>
  <body> 
    <g:if test="${blast_result}">
      <!--p>${command}</p><br-->
      <h1>BLAST result for <em>${term}</em></h1>
      
      <p><g:link controller="FileDownload" action="blast_download" params="${[fileId : blastId, fileName: 'blast_result.txt']}">Download BLAST result</g:link></p>
      
      <div id = "blast_fig">
         <script type="text/javascript" src="${resource(dir: 'js', file: 'raphael-min.js')}"></script>
      	 <script type="text/javascript" src="${resource(dir: 'js', file: 'g.raphael-min.js')}"></script>
      	 <script type="text/javascript" src="${resource(dir: 'js', file: 'g.line-min.js')}"></script>
      	 <script type="text/javascript" src="${resource(dir: 'js', file: 'biodrawing.js')}"></script>
         <script type="text/javascript">
         
         data = ${jsonData};
         var paperWidth = $('#blast_fig').width() - 40;
         var drawing = new BioDrawing();
         drawing.start(paperWidth, 'blast_fig');
         drawing.drawSpacer(20);
         drawing.drawScale(${queryInfo});
         for (var i = 0; i < data.length; i++) {        	 
         	 var hit = data[i];
         	 var start = ''
         	 var stop = ''
         	 if (hit.start > hit.stop){
         	 	 start = hit.stop
         	 	 stop = hit.start
         	 }else{
         	 	 start = hit.start
         	 	 stop = hit.stop
         	 }
         	 var hitColour = drawing.getBLASTColour(hit.score);
         	 var blastRect = drawing.drawBar(start, stop, 7, hitColour, hit.id, '');
         	 blastRect.click(function(id){
         	 		 return function(){ location.href='#'+id;}
         	 		 }(hit.id));
         	 blastRect.hover(
         	 	 function(event) {
                                this.attr({stroke: 'black', 'stroke-width' : '2'});
                                $('#' + hit.id).css("background-color", "bisque");

                            },
                            function(event) {
                                this.attr({stroke: 'black', 'stroke-width' : '0'});
                                $('#' + hit.id).css("background-color", "white");
                            }
                    );
         }
         drawing.drawSpacer(20);
         drawing.end();
         </script>
        
      </div>
      <!--p>${jsonData}</p-->
      <div class="blast_res">
          <g:each var="line" in="${blast_result}">
${line}<br>
          </g:each>
      </div>
    </g:if>
  <g:elseif test="${term}">
    <h1>Your BLAST of <em>${term}</em> produced no results</h1>
    <p>Perhaps you used the wrong BLAST program, please go <g:link controller="blast">back</g:link> and try again.</p>  
  </g:elseif>
  <g:else>
   <h1>You have not entered a fasta file</h1>
   <p>Please go <g:link controller="blast">back</g:link> and try again</p>
  </g:else>
  </body>
  


</html>
